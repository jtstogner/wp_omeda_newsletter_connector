# Omeda Integration Fixes - October 29, 2025

## Version 1.8.0

### Issues Fixed

#### 1. Deployment Not Being Created in Omeda
**Problem**: When saving a draft newsletter, the deployment was being scheduled via Action Scheduler but never actually executing, so no deployment was created in Omeda.

**Root Cause**: Action Scheduler's queue runner doesn't execute immediately during the same HTTP request, even when jobs are scheduled with 0 delay. The `trigger_action_scheduler_queue()` method was calling `ActionScheduler_QueueRunner::instance()->run()`, but this wasn't sufficient to process jobs during the current request.

**Solution**: Modified `schedule_create_deployment()` and `schedule_update_content()` to execute synchronously when `$debounce_seconds == 0`. This ensures immediate execution during the save_post hook. The async scheduling is now only used for delayed/debounced operations.

**Files Changed**:
- `includes/class-omeda-async-jobs.php`:
  - Modified `schedule_create_deployment()` to execute synchronously for immediate execution
  - Modified `schedule_update_content()` to execute synchronously for immediate execution  
  - Modified `handle_create_deployment()` to chain `handle_assign_audience()` synchronously
  - Modified `handle_assign_audience()` to chain `handle_add_content()` synchronously

#### 2. Workflow Log Missing Timestamps in UI
**Problem**: The user requested timestamps be added to the workflow logs displayed in the Newsletter Glue interface.

**Status**: The logs already include timestamps in the database (stored in `_omeda_workflow_log` post meta). The rendering in `class-omeda-hooks.php` at line 175-188 already displays timestamps. If these aren't showing properly in the NLG interface, we may need to review the specific rendering context.

**Current Implementation**:
```php
printf(
    '<div style="color:%s; margin-bottom: 3px;">[%s] [%s] %s</div>',
    $color,
    esc_html($log_data['timestamp']),  // <-- Timestamp is displayed here
    esc_html($log_data['level']),
    esc_html($log_data['message'])
);
```

### Workflow Flow (Updated)

#### On Draft Save (First Time):
1. User saves draft with a Deployment Type assigned
2. `handle_post_save()` detects no `_omeda_track_id` exists
3. `schedule_create_deployment($post_id, $config_id, 0)` is called with 0 delay
4. **Synchronous execution chain**:
   - `handle_create_deployment()` → Creates deployment in Omeda, saves Track ID
   - `handle_assign_audience()` → Assigns audience to deployment
   - `handle_add_content()` → Sends initial HTML content and subject
5. `_omeda_deployment_ready` meta is set to `true`
6. User can now send test emails or schedule the deployment

#### On Draft Update (Subsequent Saves):
1. User updates draft content
2. `handle_post_save()` detects `_omeda_track_id` exists
3. `schedule_update_content($post_id, $track_id, $config_id, 0)` is called with 0 delay
4. **Synchronous execution**: `handle_update_content()` → Updates HTML content in Omeda

### API Endpoint Verification

Verified all Omeda API endpoints match the official documentation in `/omeda_api_docs/`:
- ✅ `Email Builder/deployment/*` - Create deployment (POST)
- ✅ `omail/deployment/audience/add/*` - Assign audience (POST)
- ✅ `omail/deployment/content/*` - Add/update content (POST)
- ✅ `omail/deployment/sendtest/*` - Send test email (POST)
- ✅ `omail/deployment/schedule/*` - Schedule deployment (POST)
- ✅ `omail/deployment/lookup/{trackId}/*` - Get deployment status (GET)
- ✅ `deploymenttypes/*` - Get deployment types list (GET)

All endpoints include the required trailing `/*` as specified in the documentation.

### Testing Recommendations

1. **Create a new newsletter**:
   - Assign a Deployment Type
   - Save as draft
   - Check workflow logs - should show all 3 steps complete immediately

2. **Verify in Omeda**:
   - Log into Omeda Email Builder
   - Find the deployment by TrackID (shown in WordPress)
   - Verify audience is assigned
   - Verify content is present

3. **Update content**:
   - Modify newsletter HTML
   - Save draft again
   - Check workflow logs - should show content update complete
   - Verify updated content in Omeda

4. **Send test**:
   - Click "Send Test Email" button
   - Check configured test email address
   - Verify test email received

5. **Schedule**:
   - Select date/time
   - Check confirmation box
   - Click "Schedule Deployment"
   - Verify in Omeda that deployment is scheduled

### Known Limitations

1. **Action Scheduler for Testing Only**: Per user request, Action Scheduler is only used in development/staging environments. Production uses native WP-Cron.

2. **Immediate Execution is Synchronous**: When deployments are created or content is updated immediately (0 delay), these operations now run synchronously during the HTTP request. This ensures reliability but may slightly increase save time for large content.

3. **Database Connection Errors**: The debug log showed MySQL connection errors (`mysqli_real_connect(): (HY000/2002): Connection refused`). This indicates intermittent database connectivity issues in the wp-env environment, not related to our plugin code.

### Version History

- **1.8.0** (2025-10-29): Fixed synchronous execution for immediate deployment creation and content updates
- **1.7.2** (2025-10-29): Previous version with Action Scheduler implementation
